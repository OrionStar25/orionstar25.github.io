<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Functions, Tools, and Agents | Niharika Shrivastava</title> <meta name="author" content="Niharika Shrivastava"> <meta name="description" content="Understand the capabilities of LLMs to the fullest."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website, niharika-shrivastava"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%98%AF%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://orionstar25.github.io/blog/2024/function-calling/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Niharika </span>Shrivastava</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">opensource</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/presentations/">presentations</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/contributions/">contributions</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/repositories/">github</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/checklist/">my dynamic checklist</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Functions, Tools, and Agents</h1> <p class="post-meta">November 20, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/opensource"> <i class="fa-solid fa-hashtag fa-sm"></i> opensource</a>   <a href="/blog/tag/ai"> <i class="fa-solid fa-hashtag fa-sm"></i> ai</a>   <a href="/blog/tag/github"> <i class="fa-solid fa-hashtag fa-sm"></i> github</a>     ·   <a href="/blog/category/open-source"> <i class="fa-solid fa-tag fa-sm"></i> open-source</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="function-calling">Function Calling</h1> <p>Function calling in large language models (LLMs) is a technique that allows LLMs to interact with external tools and APIs by:</p> <ol> <li> <p><strong>Detecting when a function is needed:</strong> LLMs are fine-tuned to identify when a function needs to be called based on a user’s prompt.</p> </li> <li> <p><strong>Generating a structured response:</strong> If applicable, LLMs generate a JSON object that contains the function name and arguments.</p> </li> <li> <p><strong>Executing the function:</strong> The developer’s code executes the function using the extracted arguments and to get an output.</p> </li> <li> <p><strong>Using the function output:</strong> The LLM uses the function output to generate a final response in natural language to the user.</p> </li> </ol> <p>In this post, I will explain the common structure of function-calling, tools, and agents using LangChain and OpenAI models.</p> <h2 id="langchain-expression-language-lcel">LangChain Expression Language (LCEL)</h2> <p>LangChain is an open-source framework that allows developers to build applications using large language models (LLMs). The LangChain Expression Language (LCEL) helps to compose a chain of LangChain components with minimal code.</p> <p>Typically, a chain contains the following components seperated by the <code class="language-plaintext highlighter-rouge">|</code> operator:</p> <blockquote> <table> <tbody> <tr> <td>Prompt</td> <td>LLM</td> <td>OutputParser</td> </tr> </tbody> </table> </blockquote> <p>Below is a code example to use LCEL and an LLM to generate a chain.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span>
<span class="kn">from</span> <span class="n">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span> <span class="n">langchain.schema.output_parser</span> <span class="kn">import</span> <span class="n">StrOutputParser</span>

<span class="c1"># Create a prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">tell me a short joke about {topic}</span><span class="sh">"</span>
<span class="p">)</span>

<span class="c1"># Instantiate an LLM
</span><span class="n">model</span> <span class="o">=</span> <span class="nc">ChatOpenAI</span><span class="p">()</span>

<span class="c1"># Instantiate a parser that converts model output to string
</span><span class="n">output_parser</span> <span class="o">=</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="c1"># Create a langChain "chain" of components using LCEL
</span><span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="n">output_parser</span>

<span class="c1"># Invoke the chain to generate a response from the LLM
</span><span class="n">chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">topic</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bears</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">"</span><span class="s">Why do bears have hairy coats?</span><span class="se">\n\n</span><span class="s">Because they don</span><span class="sh">'</span><span class="s">t like to shave!</span><span class="sh">"</span>
</code></pre></div></div> <ol> <li>The user creates a string prompt.</li> <li>This prompt is sent to the LLM to generate an output.</li> <li>The LLM output object is properly parsed to generate a string response for the user.</li> </ol> <h2 id="bind-custom-functions-to-llms">Bind custom functions to LLMs</h2> <p>The purpose of function-calling is:</p> <ol> <li>To leverage an LLM to analyse a a user query in order to determine whether a function-call is required to generate the desired response.</li> <li>If a function call is required, the LLM needs to figure out the correct function to call along with the required function argument values.</li> </ol> <p>This process helps the developer to then execute the relevant function with the arguments to generate the desired response. A function could be a custom function written by the developer or an API call that generates an output based on given arguments.</p> <p>OpenAI models expect the functions to be defined in the following format:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">functions</span> <span class="o">=</span> <span class="p">[</span>
   <span class="p">{</span>
      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function_name</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">description</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="o">&lt;</span><span class="n">argument_name</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">argument_type</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">argument_description</span><span class="o">&gt;</span>
          <span class="p">},</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="nb">list</span> <span class="n">of</span> <span class="n">required</span> <span class="n">arguments</span><span class="o">&gt;</span><span class="p">]</span>
      <span class="p">}</span>
   <span class="p">},</span>
<span class="bp">...</span>
<span class="p">]</span>
</code></pre></div></div> <p>Let’s take an example with 2 custom defined functions <code class="language-plaintext highlighter-rouge">weather_search</code> and <code class="language-plaintext highlighter-rouge">sports_search</code>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the functions
</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">weather_search</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search for weather given an airport code</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="sh">"</span><span class="s">airport_code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">The airport code to get the weather for</span><span class="sh">"</span>
          <span class="p">},</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">airport_code</span><span class="sh">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
        <span class="p">{</span>
      <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">sports_search</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Search for news of recent sport events</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="sh">"</span><span class="s">team_name</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">The sports team to search for</span><span class="sh">"</span>
          <span class="p">},</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">team_name</span><span class="sh">"</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>

<span class="c1"># Create a prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">human</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Instantiate an LLM and "bind" the defined functions with the LLM.
# This tells the LLM the list of available functions to choose from in case function-calling is required.
</span><span class="n">model</span> <span class="o">=</span> <span class="nc">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">functions</span><span class="o">=</span><span class="n">functions</span><span class="p">)</span>

<span class="c1"># Create a chain
</span><span class="n">runnable</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span>
</code></pre></div></div> <p>Invoke the chain with a sports-related question:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">runnable</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">how did the patriots do yesterday?</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">function_call</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">sports_search</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">arguments</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">team_name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">New England Patriots</span><span class="sh">"</span><span class="s">}</span><span class="sh">'</span><span class="p">}})</span>
</code></pre></div></div> <ul> <li> <code class="language-plaintext highlighter-rouge">content</code> is empty because the LLM determined that a function needs to be called in order to generate a response.</li> <li> <code class="language-plaintext highlighter-rouge">function_call</code> containts the following information: <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="sh">'</span><span class="s">function_call</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
 <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">sports_search</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># the custom function that needs to be called 
</span> <span class="sh">'</span><span class="s">arguments</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">team_name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">New England Patriots</span><span class="sh">"</span><span class="s">}</span><span class="sh">'</span> <span class="c1"># the arguments to the function.
</span><span class="p">}</span>
</code></pre></div> </div> <p>The LLM automatically determined that <code class="language-plaintext highlighter-rouge">patriots</code> in the user query referred to the <code class="language-plaintext highlighter-rouge">New England Patriots</code> which is a sports team. Interesting!</p> </li> </ul> <p>Now, let’s invoke the chain with a weather related question:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">runnable</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">what is the weather in sf</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">function_call</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">weather_search</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">arguments</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">airport_code</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">SFO</span><span class="sh">"</span><span class="s">}</span><span class="sh">'</span><span class="p">}})</span>
</code></pre></div></div> <p>This time, the LLM determined that the function <code class="language-plaintext highlighter-rouge">weather_search</code> needs to be called with the argument <code class="language-plaintext highlighter-rouge">airport_code=SFO</code> where <code class="language-plaintext highlighter-rouge">SFO</code> stands for San Francisco!</p> <p>By default, if none of the defined functions are relevant to the user query, the LLM will not invoke function-calling and generate a normal user (natural language) response. It doesn’t forcibly use any function or hallucinate its arguments - until explicitely made to do so.</p> <h2 id="use-pydantic-to-create-functions-with-ease">Use pydantic to create functions with ease</h2> <p>Pydantic is a Python library for data validation using Python-type annotations. It ensures that the data you work with matches your specified data types, simplifying error handling and data parsing in Python applications.</p> <p>Thus, Pydantic will help us define LLM functions with ease. Let’s look at an example:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define a Pydantic class which refers to a function
# The fields of the class refer to function arguments
# The docstring used to describe the class is mandatory as it helps the LLM understand what the purpose of the function is. 
</span>
<span class="k">class</span> <span class="nc">WeatherSearch</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Call this with an airport code to get the weather at that airport</span><span class="sh">"""</span>
    <span class="n">airport_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">airport code to get weather for</span><span class="sh">"</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">langchain.utils.openai_functions</span> <span class="kn">import</span> <span class="n">convert_pydantic_to_openai_function</span>
<span class="nf">convert_pydantic_to_openai_function</span><span class="p">(</span><span class="n">WeatherSearch</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">WeatherSearch</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># name of the class
</span> <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Call this with an airport code to get the weather at that airport</span><span class="sh">'</span><span class="p">,</span> <span class="c1"># Pulled from the docstring used to describe the class.
</span> <span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">WeatherSearch</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Call this with an airport code to get the weather at that airport</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">object</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">airport_code</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Airport Code</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">airport code to get weather for</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">string</span><span class="sh">'</span><span class="p">}},</span>
  <span class="sh">'</span><span class="s">required</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">airport_code</span><span class="sh">'</span><span class="p">]}}</span>
</code></pre></div></div> <p>Let’s create multiple functions using Pydantic!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Custom function with 2 args
</span><span class="k">class</span> <span class="nc">ArtistSearch</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Call this to get the names of songs by a particular artist</span><span class="sh">"""</span>
    <span class="n">artist_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">name of artist to look up</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">number of results</span><span class="sh">"</span><span class="p">)</span>

<span class="n">functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">convert_pydantic_to_openai_function</span><span class="p">(</span><span class="n">WeatherSearch</span><span class="p">),</span>
    <span class="nf">convert_pydantic_to_openai_function</span><span class="p">(</span><span class="n">ArtistSearch</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Bind the functions to the LLM
</span><span class="n">model_with_functions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">functions</span><span class="o">=</span><span class="n">functions</span><span class="p">)</span>
</code></pre></div></div> <p>Invoking with weather related question:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_with_functions</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">what is the weather in sf?</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">function_call</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">WeatherSearch</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">arguments</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">airport_code</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">SFO</span><span class="sh">"</span><span class="s">}</span><span class="sh">'</span><span class="p">}})</span>
</code></pre></div></div> <p>Invoking with artist related question:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_with_functions</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">what are three songs by taylor swift?</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">function_call</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ArtistSearch</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">arguments</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">{</span><span class="sh">"</span><span class="s">artist_name</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">Taylor Swift</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">n</span><span class="sh">"</span><span class="s">:3}</span><span class="sh">'</span><span class="p">}})</span>
</code></pre></div></div> <p>Default behaviour:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_with_functions</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">hi!</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">Hello! How can I assist you today?</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <h2 id="extraction">Extraction</h2> <p>Concept extraction is an NLP task that automatically identifies and extracts specific concepts or entities from unstructured text.</p> <p>Let’s see how function-calling can help us solve this task of extracting all the papers and their respective authors mentioned in an unstructured article with ease.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load unstructured text from the internet
</span><span class="kn">from</span> <span class="n">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">WebBaseLoader</span>
<span class="n">loader</span> <span class="o">=</span> <span class="nc">WebBaseLoader</span><span class="p">(</span><span class="sh">"</span><span class="s">https://lilianweng.github.io/posts/2023-06-23-agent/</span><span class="sh">"</span><span class="p">)</span>
<span class="n">documents</span> <span class="o">=</span> <span class="n">loader</span><span class="p">.</span><span class="nf">load</span><span class="p">()</span>
<span class="n">page_content</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_content</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]</span>

<span class="c1"># Create a prompt
</span><span class="n">template</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">A article will be passed to you. Extract from it all papers that are mentioned by this article followed by its author. 

Do not extract the name of the article itself. If no papers are mentioned that</span><span class="sh">'</span><span class="s">s fine - you don</span><span class="sh">'</span><span class="s">t need to extract any! Just return an empty list.

Do not make up or guess ANY extra information. Only extract what exactly is in the text.</span><span class="sh">"""</span>

<span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">human</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Create custom function definitions
</span><span class="k">class</span> <span class="nc">Paper</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Information about papers mentioned.</span><span class="sh">"""</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Info</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Information to extract</span><span class="sh">"""</span>
    <span class="n">papers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Paper</span><span class="p">]</span>

<span class="n">paper_extraction_function</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nf">convert_pydantic_to_openai_function</span><span class="p">(</span><span class="n">Info</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Bind the function to the LLM
</span><span class="n">extraction_model</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span>
    <span class="n">functions</span><span class="o">=</span><span class="n">paper_extraction_function</span><span class="p">,</span> <span class="c1"># functions present for binding
</span>    <span class="n">function_call</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Info</span><span class="sh">"</span><span class="p">}</span> <span class="c1"># Force the LLM to use the function "Info" everytime
</span><span class="p">)</span>

<span class="c1"># Create a chain and invoke it with the article
</span><span class="n">extraction_chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">extraction_model</span> <span class="o">|</span> <span class="nc">JsonKeyOutputFunctionsParser</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="sh">"</span><span class="s">papers</span><span class="sh">"</span><span class="p">)</span>
<span class="n">extraction_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">page_content</span><span class="p">})</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Chain of thought (CoT; Wei et al. 2022)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Wei et al. 2022</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Tree of Thoughts (Yao et al. 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Yao et al. 2023</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">LLM+P (Liu et al. 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Liu et al. 2023</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ReAct (Yao et al. 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Yao et al. 2023</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Reflexion (Shinn &amp; Labash 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Shinn &amp; Labash 2023</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Chain of Hindsight (CoH; Liu et al. 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Liu et al. 2023</span><span class="sh">'</span><span class="p">},</span>
 <span class="p">{</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Algorithm Distillation (AD; Laskin et al. 2023)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">author</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Laskin et al. 2023</span><span class="sh">'</span><span class="p">}]</span>
</code></pre></div></div> <p>The chain has successfully extracted all the papers that were mentioned in the article along with its authors in a structured JSON format.</p> <p>That’s all for function-calling (for now)!</p> <h1 id="tools-and-routing">Tools and Routing</h1> <ol> <li> <p><strong>Tools:</strong> Functions and services an LLM can utilize to extend its capabilities are named “tools” in LangChain.</p> </li> <li> <p><strong>Routing:</strong> Selecting from multiple possible tools is called “routing”.</p> </li> </ol> <h2 id="tools">Tools</h2> <p>Let’s create a function <code class="language-plaintext highlighter-rouge">get_current_temperature()</code> that calls an external weather API to get the temperature forecast for the next day.</p> <p>Each function can be converted into a tool using the <code class="language-plaintext highlighter-rouge">@tool</code> decorator. <code class="language-plaintext highlighter-rouge">args_schema</code> specifies the format of the args for this function.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.agents</span> <span class="kn">import</span> <span class="n">tool</span>

<span class="c1"># Define the input schema
</span><span class="k">class</span> <span class="nc">OpenMeteoInput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Latitude of the location to fetch weather data for</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Longitude of the location to fetch weather data for</span><span class="sh">"</span><span class="p">)</span>

<span class="nd">@tool</span><span class="p">(</span><span class="n">args_schema</span><span class="o">=</span><span class="n">OpenMeteoInput</span><span class="p">)</span> <span class="c1"># args_schema tells the format of the args for this function
</span><span class="k">def</span> <span class="nf">get_current_temperature</span><span class="p">(</span><span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Fetch current temperature for given coordinates.</span><span class="sh">"""</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://api.open-meteo.com/v1/forecast</span><span class="sh">"</span>
    
    <span class="c1"># Parameters for the request
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">:</span> <span class="n">latitude</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="p">:</span> <span class="n">longitude</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">hourly</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">temperature_2m</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">forecast_days</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Make the request
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">API Request failed with status code: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">current_utc_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">()</span>
    <span class="n">time_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">fromisoformat</span><span class="p">(</span><span class="n">time_str</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">Z</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">+00:00</span><span class="sh">'</span><span class="p">))</span> <span class="k">for</span> <span class="n">time_str</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">hourly</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">time</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">temperature_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">hourly</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">temperature_2m</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="n">closest_time_index</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">time_list</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nf">abs</span><span class="p">(</span><span class="n">time_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_utc_time</span><span class="p">))</span>
    <span class="n">current_temperature</span> <span class="o">=</span> <span class="n">temperature_list</span><span class="p">[</span><span class="n">closest_time_index</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="sa">f</span><span class="sh">'</span><span class="s">The current temperature is </span><span class="si">{</span><span class="n">current_temperature</span><span class="si">}</span><span class="s">°C</span><span class="sh">'</span>
</code></pre></div></div> <p>Every tool has the following properties:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_current_temperature</span><span class="p">.</span><span class="n">name</span>
<span class="o">&gt;</span> <span class="sh">'</span><span class="s">get_current_temperature</span><span class="sh">'</span>

<span class="n">get_current_temperature</span><span class="p">.</span><span class="n">description</span>
<span class="o">&gt;</span> <span class="sh">'</span><span class="s">get_current_temperature(latitude: float, longitude: float) -&gt; dict - Fetch current temperature for given coordinates.</span><span class="sh">'</span>

<span class="c1"># followed the defined schema
</span><span class="n">get_current_temperature</span><span class="p">.</span><span class="n">args</span>
<span class="o">&gt;</span> <span class="sh">"</span><span class="s">{</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Latitude of the location to fetch weather data for</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">number</span><span class="sh">'</span><span class="s">},
 </span><span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Longitude of the location to fetch weather data for</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">number</span><span class="sh">'</span><span class="s">}}</span><span class="sh">"</span>
</code></pre></div></div> <p>You can convert any tool into an openai function format.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.tools.render</span> <span class="kn">import</span> <span class="n">format_tool_to_openai_function</span>

<span class="nf">format_tool_to_openai_function</span><span class="p">(</span><span class="n">get_current_temperature</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="sh">"</span><span class="s">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">get_current_temperature</span><span class="sh">'</span><span class="s">,
 </span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">get_current_temperature(latitude: float, longitude: float) -&gt; dict - Fetch current temperature for given coordinates.</span><span class="sh">'</span><span class="s">,
 </span><span class="sh">'</span><span class="s">parameters</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">OpenMeteoInput</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">object</span><span class="sh">'</span><span class="s">,
  </span><span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="s">,
    </span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Latitude of the location to fetch weather data for</span><span class="sh">'</span><span class="s">,
    </span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">number</span><span class="sh">'</span><span class="s">},
   </span><span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="s">: {</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="s">,
    </span><span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Longitude of the location to fetch weather data for</span><span class="sh">'</span><span class="s">,
    </span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">number</span><span class="sh">'</span><span class="s">}},
  </span><span class="sh">'</span><span class="s">required</span><span class="sh">'</span><span class="s">: [</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="s">]}}</span><span class="sh">"</span>
</code></pre></div></div> <h2 id="routing">Routing</h2> <p>Let’s create another tool <code class="language-plaintext highlighter-rouge">search_wikipedia()</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">wikipedia</span>
<span class="nd">@tool</span>
<span class="k">def</span> <span class="nf">search_wikipedia</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Run Wikipedia search and get page summaries.</span><span class="sh">"""</span>
    <span class="n">page_titles</span> <span class="o">=</span> <span class="n">wikipedia</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">page_title</span> <span class="ow">in</span> <span class="n">page_titles</span><span class="p">[:</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wiki_page</span> <span class="o">=</span>  <span class="n">wikipedia</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">page_title</span><span class="p">,</span> <span class="n">auto_suggest</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">summaries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Page: </span><span class="si">{</span><span class="n">page_title</span><span class="si">}</span><span class="se">\n</span><span class="s">Summary: </span><span class="si">{</span><span class="n">wiki_page</span><span class="p">.</span><span class="n">summary</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">except </span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">wiki_client</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">PageError</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">wiki_client</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">DisambiguationError</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">summaries</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">No good Wikipedia Search Result was found</span><span class="sh">"</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>
</code></pre></div></div> <p>The response of running any tool can be either:</p> <ol> <li> <strong>AgentAction</strong>: specifies what the next action should be in order to get the final response, i.e., call a specific function using arguments after analysing the user input query.</li> <li> <strong>AgentFinish</strong>: provides final user content/response.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.schema.agent</span> <span class="kn">import</span> <span class="n">AgentFinish</span>

<span class="c1"># create a routing 
</span><span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="c1"># If the result is AgentFinish, no more action is needed.
</span>    <span class="c1"># return the final output to the user
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">return_values</span><span class="p">[</span><span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">search_wikipedia</span><span class="sh">"</span><span class="p">:</span> <span class="n">search_wikipedia</span><span class="p">,</span> 
            <span class="sh">"</span><span class="s">get_current_temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">get_current_temperature</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># call the function identified by the LLM with the corresponding args
</span>        <span class="k">return</span> <span class="n">tools</span><span class="p">[</span><span class="n">result</span><span class="p">.</span><span class="n">tool</span><span class="p">].</span><span class="nf">run</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">tool_input</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a chain that 
</span>  <span class="c1"># takes a prompt, 
</span>  <span class="c1"># identifies if function calling is required, 
</span>  <span class="c1"># parses the output, 
</span>  <span class="c1"># routes to the required function-call, executes the function to retrieve the final response.
</span><span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">OpenAIFunctionsAgentOutputParser</span><span class="p">()</span> <span class="o">|</span> <span class="n">route</span>

<span class="c1"># This used AgentAction to call `get_current_weather()`
</span><span class="n">result</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">What is the weather in san francisco right now?</span><span class="sh">"</span><span class="p">})</span>
<span class="o">&gt;</span> <span class="sh">'</span><span class="s">The current temperature is 12.1°C</span><span class="sh">'</span>

<span class="c1"># This used AgentFinish since no function-call was required
</span><span class="n">chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">hi!</span><span class="sh">"</span><span class="p">})</span>
<span class="o">&gt;</span> <span class="sh">'</span><span class="s">Hello! How can I assist you today?</span><span class="sh">'</span>
</code></pre></div></div> <h1 id="conversational-agents">Conversational Agents</h1> <h2 id="what-are-agents">What are agents?</h2> <p>A combination of LLMs and code. LLMs reason about what steps to take and call for actions.</p> <h2 id="agent-loop">Agent Loop</h2> <ol> <li>Choose a tool to use.</li> <li>Observe the output of the tool.</li> <li>Repeat until a stopping condition is met. <ul> <li>LLM determined.</li> <li>Hardcorded rules.</li> </ul> </li> </ol> <p>Give the LLM all intermediate results and their observations for the LLM to identify the next steps. This is done by populating intermediate results in <code class="language-plaintext highlighter-rouge">agent_scratchpad</code> inside the prompt everytime the LLM is called.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.schema.runnable</span> <span class="kn">import</span> <span class="n">RunnablePassthrough</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">OpenAIFunctionsAgentOutputParser</span><span class="p">()</span>
<span class="c1"># RunnablePassthrough helps in passing intermediate steps in the prompt everytime the LLM is called
</span><span class="n">agent_chain</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span>
    <span class="n">agent_scratchpad</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">format_to_openai_functions</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">intermediate_steps</span><span class="sh">"</span><span class="p">])</span>
<span class="p">)</span> <span class="o">|</span> <span class="n">chain</span>

<span class="k">def</span> <span class="nf">run_agent</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
    <span class="n">intermediate_steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">agent_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">,</span> 
            <span class="sh">"</span><span class="s">intermediate_steps</span><span class="sh">"</span><span class="p">:</span> <span class="n">intermediate_steps</span>
        <span class="p">})</span>

        <span class="c1"># if final output is received, return 
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">tool</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">search_wikipedia</span><span class="sh">"</span><span class="p">:</span> <span class="n">search_wikipedia</span><span class="p">,</span> 
            <span class="sh">"</span><span class="s">get_current_temperature</span><span class="sh">"</span><span class="p">:</span> <span class="n">get_current_temperature</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">result</span><span class="p">.</span><span class="n">tool</span><span class="p">]</span>
        
        <span class="c1"># get the observation from the respective tool
</span>        <span class="n">observation</span> <span class="o">=</span> <span class="n">tool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">tool_input</span><span class="p">)</span>

        <span class="c1"># populate the tool used and its observation in the prompt for next iteration
</span>        <span class="n">intermediate_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">observation</span><span class="p">))</span>


<span class="nf">run_agent</span><span class="p">(</span><span class="sh">"</span><span class="s">what is the weather is sf?</span><span class="sh">"</span><span class="p">)</span>

<span class="o">&gt;</span> <span class="nc">AgentFinish</span><span class="p">(</span><span class="n">return_values</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">The current temperature in San Francisco is 11.8°C.</span><span class="sh">'</span><span class="p">},</span> <span class="n">log</span><span class="o">=</span><span class="sh">'</span><span class="s">The current temperature in San Francisco is 11.8°C.</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">agent_executor</code> is a helpful abstraction to create e-2-e agents.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.agents</span> <span class="kn">import</span> <span class="n">AgentExecutor</span>

<span class="n">agent_executor</span> <span class="o">=</span> <span class="nc">AgentExecutor</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent_chain</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">agent_executor</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">what is langchain?</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; Entering new AgentExecutor chain...

Invoking: `search_wikipedia` with `{'query': 'Langchain'}`

Page: LangChain
Summary: LangChain is a software framework that helps facilitate the integration of large language models (LLMs) into applications. As a language model integration framework
...
&gt; Finished chain.

{'input': 'what is langchain?',
 'output': 'LangChain is a software framework that helps facilitate the integration of large language models (LLMs) into applications. It is used for document analysis and summarization, chatbots, and code analysis.'}
</code></pre></div></div> <h2 id="chat-history">Chat History</h2> <p>By default, LLMs don’t have history of previous interactions. We can add the chat history using <code class="language-plaintext highlighter-rouge">ConversationBufferMemory</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.memory</span> <span class="kn">import</span> <span class="n">ConversationBufferMemory</span>

<span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">([</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">You are helpful but sassy assistant</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">),</span> <span class="c1"># populate the chat history inside prompt here
</span>    <span class="p">(</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">),</span>
    <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="sh">"</span><span class="s">agent_scratchpad</span><span class="sh">"</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># keep the history inside memory buffer
</span><span class="n">memory</span> <span class="o">=</span> <span class="nc">ConversationBufferMemory</span><span class="p">(</span><span class="n">return_messages</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">memory_key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">)</span>

<span class="n">agent_executor</span> <span class="o">=</span> <span class="nc">AgentExecutor</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent_chain</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">agent_executor</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">my name is bob</span><span class="sh">"</span><span class="p">})</span>
<span class="o">&gt;</span> <span class="n">Entering</span> <span class="n">new</span> <span class="n">AgentExecutor</span> <span class="n">chain</span><span class="bp">...</span>
<span class="n">Hello</span> <span class="n">Bob</span><span class="err">!</span> <span class="n">How</span> <span class="n">can</span> <span class="n">I</span> <span class="n">assist</span> <span class="n">you</span> <span class="n">today</span><span class="err">?</span>

<span class="o">&gt;</span> <span class="n">Finished</span> <span class="n">chain</span><span class="p">.</span>
<span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">my name is bob</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">chat_history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">my name is bob</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">Hello Bob! How can I assist you today?</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Hello Bob! How can I assist you today?</span><span class="sh">'</span><span class="p">}</span>

<span class="o">----------</span>

<span class="n">agent_executor</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">whats my name</span><span class="sh">"</span><span class="p">})</span>

<span class="o">&gt;</span> <span class="n">Entering</span> <span class="n">new</span> <span class="n">AgentExecutor</span> <span class="n">chain</span><span class="bp">...</span>
<span class="n">Your</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">Bob</span><span class="p">.</span> <span class="n">How</span> <span class="n">can</span> <span class="n">I</span> <span class="n">assist</span> <span class="n">you</span> <span class="n">today</span><span class="p">,</span> <span class="n">Bob</span><span class="err">?</span>

<span class="o">&gt;</span> <span class="n">Finished</span> <span class="n">chain</span><span class="p">.</span>
<span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">whats my name</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">chat_history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">my name is bob</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">Hello Bob! How can I assist you today?</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">whats my name</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">Your name is Bob. How can I assist you today, Bob?</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Your name is Bob. How can I assist you today, Bob?</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div> <h2 id="chatbot">Chatbot</h2> <p>Let’s make a conversational bot using everything we learnt!! Also, I am on a time-constraint right now, that’s why I’m just re-iterating what the tutorial taught. But someday (when I have enough time and I’m feeling creative), I’ll create a fun chatbot of my own.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">panel</span> <span class="k">as</span> <span class="n">pn</span>  <span class="c1"># GUI
</span><span class="n">pn</span><span class="p">.</span><span class="nf">extension</span><span class="p">()</span>
<span class="kn">import</span> <span class="n">panel</span> <span class="k">as</span> <span class="n">pn</span>
<span class="kn">import</span> <span class="n">param</span>


<span class="c1"># A helper class to conbine all concepts learnt above
</span><span class="k">class</span> <span class="nc">cbfs</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">Parameterized</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">cbfs</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="nf">format_tool_to_openai_function</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">bind</span><span class="p">(</span><span class="n">functions</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">functions</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="nc">ConversationBufferMemory</span><span class="p">(</span><span class="n">return_messages</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">memory_key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">([</span>
            <span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">You are helpful but sassy assistant</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">(</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">),</span>
            <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="sh">"</span><span class="s">agent_scratchpad</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span>
            <span class="n">agent_scratchpad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nf">format_to_openai_functions</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">intermediate_steps</span><span class="sh">"</span><span class="p">])</span>
        <span class="p">)</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">prompt</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">|</span> <span class="nc">OpenAIFunctionsAgentOutputParser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">qa</span> <span class="o">=</span> <span class="nc">AgentExecutor</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">memory</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">convchain</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">inp</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">qa</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>
        <span class="n">self</span><span class="p">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">]</span> 
        <span class="n">self</span><span class="p">.</span><span class="n">panels</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span>
            <span class="n">pn</span><span class="p">.</span><span class="nc">Row</span><span class="p">(</span><span class="sh">'</span><span class="s">User:</span><span class="sh">'</span><span class="p">,</span> <span class="n">pn</span><span class="p">.</span><span class="n">pane</span><span class="p">.</span><span class="nc">Markdown</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">450</span><span class="p">)),</span>
            <span class="n">pn</span><span class="p">.</span><span class="nc">Row</span><span class="p">(</span><span class="sh">'</span><span class="s">ChatBot:</span><span class="sh">'</span><span class="p">,</span> <span class="n">pn</span><span class="p">.</span><span class="n">pane</span><span class="p">.</span><span class="nc">Markdown</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">answer</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">styles</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">background-color</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">#F6F6F6</span><span class="sh">'</span><span class="p">}))</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">pn</span><span class="p">.</span><span class="nc">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">panels</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">clr_history</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">chat_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> 
</code></pre></div></div> <p>Putting it all together in a nice simple UI.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cb</span> <span class="o">=</span> <span class="nf">cbfs</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
<span class="n">inp</span> <span class="o">=</span> <span class="n">pn</span><span class="p">.</span><span class="n">widgets</span><span class="p">.</span><span class="nc">TextInput</span><span class="p">(</span> <span class="n">placeholder</span><span class="o">=</span><span class="sh">'</span><span class="s">Enter text here…</span><span class="sh">'</span><span class="p">)</span>
<span class="n">conversation</span> <span class="o">=</span> <span class="n">pn</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">cb</span><span class="p">.</span><span class="n">convchain</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span> 

<span class="n">tab1</span> <span class="o">=</span> <span class="n">pn</span><span class="p">.</span><span class="nc">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="p">.</span><span class="nc">Row</span><span class="p">(</span><span class="n">inp</span><span class="p">),</span>
    <span class="n">pn</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="nc">Divider</span><span class="p">(),</span>
    <span class="n">pn</span><span class="p">.</span><span class="nf">panel</span><span class="p">(</span><span class="n">conversation</span><span class="p">,</span>  <span class="n">loading_indicator</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">),</span>
    <span class="n">pn</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="nc">Divider</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">dashboard</span> <span class="o">=</span> <span class="n">pn</span><span class="p">.</span><span class="nc">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="p">.</span><span class="nc">Row</span><span class="p">(</span><span class="n">pn</span><span class="p">.</span><span class="n">pane</span><span class="p">.</span><span class="nc">Markdown</span><span class="p">(</span><span class="sh">'</span><span class="s"># QnA_Bot</span><span class="sh">'</span><span class="p">)),</span>
    <span class="n">pn</span><span class="p">.</span><span class="nc">Tabs</span><span class="p">((</span><span class="sh">'</span><span class="s">Conversation</span><span class="sh">'</span><span class="p">,</span> <span class="n">tab1</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">dashboard</span>
</code></pre></div></div> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/chatbot-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/chatbot-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/chatbot-1400.webp"></source> <img src="/assets/img/chatbot.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <hr> <p>That’s all folks! I have a few other agent concepts to learn in the pipeline. Let the learning continue 😄.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/multi-agents/">Multi-Agents with CrewAI</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/fl-challenge-day-10/">Red Teaming LLM Applications</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/agentic-rag/">Agentic RAG with LlamaIndex</a> </li> <div id="giscus_thread" style="max-width: 1200px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"OrionStar25/orionstar25.github.io","data-repo-id":"R_kgDOK7Nn4Q","data-category":"Announcements","data-category-id":"DIC_kwDOK7Nn4c4Ce3KD","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Niharika Shrivastava. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>