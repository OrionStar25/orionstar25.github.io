<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Introduction to Federated Learning | Niharika Shrivastava</title> <meta name="author" content="Niharika Shrivastava"> <meta name="description" content=""> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website, niharika-shrivastava"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%98%AF%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://orionstar25.github.io/blog/2024/fl-challenge-day-1/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Niharika </span>Shrivastava</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">opensource</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/presentations/">presentations</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/contributions/">contributions</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/repositories/">github</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/checklist/">my dynamic checklist</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Introduction to Federated Learning</h1> <p class="post-meta">November 21, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/opensource"> <i class="fa-solid fa-hashtag fa-sm"></i> opensource</a>   <a href="/blog/tag/ai"> <i class="fa-solid fa-hashtag fa-sm"></i> ai</a>   <a href="/blog/tag/federated-learning"> <i class="fa-solid fa-hashtag fa-sm"></i> federated-learning</a>   <a href="/blog/tag/openmined"> <i class="fa-solid fa-hashtag fa-sm"></i> openmined</a>   <a href="/blog/tag/challenge"> <i class="fa-solid fa-hashtag fa-sm"></i> challenge</a>   <a href="/blog/tag/data-privacy"> <i class="fa-solid fa-hashtag fa-sm"></i> data-privacy</a>   <a href="/blog/tag/trustworthy-ai"> <i class="fa-solid fa-hashtag fa-sm"></i> trustworthy-ai</a>     ·   <a href="/blog/category/open-source"> <i class="fa-solid fa-tag fa-sm"></i> open-source</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>It’s Day 1 of the <a href="https://info.openmined.org/30daysofflcode" rel="external nofollow noopener" target="_blank">#30DaysOfFLCode</a> Challenge by <a href="https://openmined.org/" rel="external nofollow noopener" target="_blank">OpenMined</a> 🥳!</p> <p>Today I went through an introductory tutorial on Federated Learning by <a href="https://learn.deeplearning.ai/" rel="external nofollow noopener" target="_blank">DeepLearning.AI</a> and <a href="https://flower.ai/" rel="external nofollow noopener" target="_blank">Flower Labs</a>: <a href="https://learn.deeplearning.ai/courses/intro-to-federated-learning/" rel="external nofollow noopener" target="_blank">Intro to Federated Learning</a>.</p> <p>Let’s quickly learn a few concepts ⬇️.</p> <h1 id="introduction-">Introduction 📉</h1> <h2 id="why-is-federated-learning-needed">Why is federated learning needed?</h2> <ol> <li> <p>Llama-3 is trained on 15 trillion tokens which happens to be very close to the amount of publicly available data. According to a study, we will run out of new publicly available data to further train our models by 2026. In contrast, about 150 trillion tokens are expected to be present in all of the private data globally (e.g., in text messages and emails). This data is not freely accessible for model training.</p> </li> <li> <p>All the data is naturally distributed across industries, geographic locations, devices. For e.g.,</p> <ul> <li>tons of medical data is distributed among different hospitals.</li> <li>individual data is distributed amongst mobile, laptop, home assistants, etc.</li> </ul> </li> </ol> <p>Traditional data science methods require all the data to be centrally placed during training. Collecting more data doesn’t work for multiple reasons:</p> <ul> <li> <strong>Sensitive data:</strong> Data can be either sensitve or bound by regulations barring it from being used/moved freely.</li> <li> <strong>Data volume:</strong> It can be huge which might cause constraints on storage and computation.</li> <li> <strong>Practicality:</strong> It might not be feasible to collect a lot of data often.</li> </ul> <p>To address these issues, AI models started to shift to a decentralized approach, and a new concept called “federated learning” has emerged.</p> <p>Federated learning (often referred to as collaborative learning) is a decentralized approach to training machine learning models. <strong>It brings the training process to the data than data to the training.</strong> It doesn’t require an exchange of data from clients to centralised servers. Organizations retain full control over their data.</p> <p>A few examples of where its used:</p> <ol> <li> <p><strong>Global model for anti-money laundering model:</strong> Build a global model to detect money-laundering activity using the customer transcations in USA and EU without moving the data from their respective geographic locations. This makes sure the respective data regulations are followed without compromising model training.</p> </li> <li> <p><strong>Google GBoard on Android:</strong> A popular example wherein it is deployed on millions of edge devices to predict the next word based on each user’s data pattern. The model uses FL to learn accurate predictions without needing the data of each user.</p> </li> </ol> <h2 id="bad-generalization-capabilities-due-to-lack-of-complete-data-distribution">Bad Generalization Capabilities due to lack of Complete Data Distribution</h2> <p>Say 3 people have 3 different data distributions of the MNIST dataset each with a few digits missing.</p> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/fl-mnist-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/fl-mnist-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/fl-mnist-1400.webp"></source> <img src="/assets/img/fl-mnist.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>By training 3 different models on the these datasets, we observe the average accuracy of all 3 models to be <code class="language-plaintext highlighter-rouge">~67%</code>. Morevover, the accuracy on specifically the missing data for each model is <code class="language-plaintext highlighter-rouge">0%</code>. This is not a good performing model at all - and in fact a very real challenge.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model 1-&gt; 
  Test Accuracy on all digits: 0.6570, 
  Test Accuracy on [1,3,7]: 0.0000

Model 2-&gt; 
  Test Accuracy on all digits: 0.6876, 
  Test Accuracy on [2,5,8]: 0.0000

Model 3-&gt; 
  Test Accuracy on all digits: 0.6848, 
  Test Accuracy on [4,6,9]: 0.0000
</code></pre></div></div> <div class="row justify-content-sm-center"> <div class="col-sm-8 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/model1_cm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/model1_cm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/model1_cm-1400.webp"></source> <img src="/assets/img/model1_cm.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Clearly, the models perform very bad on data it has never seen.</p> <p>Thus, we’ll now see a big advantage of FL is that all parties can learn from each others data without compromising any private data leakage between them.</p> <h1 id="federated-learning-process">Federated Learning Process</h1> <p><img src="https://framerusercontent.com/images/pGx10j45WZIitkcA6GjZ2SITMw.webp" alt=""></p> <h2 id="algorithm">Algorithm</h2> <ol> <li> <p><strong>Initialization:</strong> Server initializes the global model.</p> </li> <li> <strong>Communication Round:</strong> For each round: <ul> <li>Server sends the global model to the participating clients.</li> <li>Each client receives the global model.</li> </ul> </li> <li> <strong>Client Training and Model Update:</strong> For each participating client: <ul> <li>Client trains the received model on its local dataset <ul> <li>usually for 1-2 epochs.</li> <li>overfitting the model on 1 client is bad for the process.</li> </ul> </li> <li>Client sends its locally updated model to the server.</li> </ul> </li> <li> <p><strong>Model Aggregation:</strong> Server aggregates the updated models received from all the clienrs using an Aggregating strategy (e.g., FedAvg).</p> </li> <li> <strong>Convergence Check:</strong> <ul> <li>If convergence critiria is met, end the FL process.</li> <li>If not, procedd to the nect communication round (step 2).</li> </ul> </li> </ol> <h2 id="implement-using-flower">Implement using Flower</h2> <ol> <li>Download relevant data.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">flwr.client</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">ClientApp</span><span class="p">,</span> <span class="n">NumPyClient</span>
<span class="kn">from</span> <span class="n">flwr.common</span> <span class="kn">import</span> <span class="n">ndarrays_to_parameters</span><span class="p">,</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="n">flwr.server</span> <span class="kn">import</span> <span class="n">ServerApp</span><span class="p">,</span> <span class="n">ServerConfig</span>
<span class="kn">from</span> <span class="n">flwr.server</span> <span class="kn">import</span> <span class="n">ServerAppComponents</span>
<span class="kn">from</span> <span class="n">flwr.server.strategy</span> <span class="kn">import</span> <span class="n">FedAvg</span>
<span class="kn">from</span> <span class="n">flwr.simulation</span> <span class="kn">import</span> <span class="n">run_simulation</span>


<span class="c1"># download mnist dataset
</span><span class="n">trainset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">MNIST</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">./MNIST_data/</span><span class="sh">"</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
<span class="p">)</span>

<span class="c1"># split into 3 different parts to simulate different clients
</span><span class="n">total_length</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">trainset</span><span class="p">)</span>
<span class="n">split_size</span> <span class="o">=</span> <span class="n">total_length</span> <span class="o">//</span> <span class="mi">3</span>
<span class="n">torch</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">part1</span><span class="p">,</span> <span class="n">part2</span><span class="p">,</span> <span class="n">part3</span> <span class="o">=</span> <span class="nf">random_split</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="p">[</span><span class="n">split_size</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">part1</span> <span class="o">=</span> <span class="nf">exclude_digits</span><span class="p">(</span><span class="n">part1</span><span class="p">,</span> <span class="n">excluded_digits</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">part2</span> <span class="o">=</span> <span class="nf">exclude_digits</span><span class="p">(</span><span class="n">part2</span><span class="p">,</span> <span class="n">excluded_digits</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
<span class="n">part3</span> <span class="o">=</span> <span class="nf">exclude_digits</span><span class="p">(</span><span class="n">part3</span><span class="p">,</span> <span class="n">excluded_digits</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>

<span class="n">train_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">part1</span><span class="p">,</span> <span class="n">part2</span><span class="p">,</span> <span class="n">part3</span><span class="p">]</span>

<span class="c1"># Common testset
</span><span class="n">testset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">.</span><span class="nc">MNIST</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">./MNIST_data/</span><span class="sh">"</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
<span class="p">)</span>

<span class="n">testset_137</span> <span class="o">=</span> <span class="nf">include_digits</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">testset_258</span> <span class="o">=</span> <span class="nf">include_digits</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
<span class="n">testset_469</span> <span class="o">=</span> <span class="nf">include_digits</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
</code></pre></div></div> <ol> <li>Define the following functions. <ul> <li> <code class="language-plaintext highlighter-rouge">set_weights</code>: each client uses it to set the global params to the individual model.</li> <li> <code class="language-plaintext highlighter-rouge">get_weights</code>: each client retrieves the model weight after individual training and returns to server.</li> </ul> </li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sets the parameters of the model
</span><span class="k">def</span> <span class="nf">set_weights</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="n">params_dict</span> <span class="o">=</span> <span class="nf">zip</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">().</span><span class="nf">keys</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="nc">OrderedDict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">net</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Retrieves the parameters from the model
</span><span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="n">ndarrays</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">val</span><span class="p">.</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">net</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">().</span><span class="nf">items</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">ndarrays</span>
</code></pre></div></div> <ol> <li>Create a <code class="language-plaintext highlighter-rouge">FlowerClient</code> to train and evaluate each client model. Flower calls <code class="language-plaintext highlighter-rouge">client_fn</code> whenever it needs an instance of one particular client to call fit or evaluate.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FlowerClient</span><span class="p">(</span><span class="n">NumPyClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">testset</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">net</span>
        <span class="n">self</span><span class="p">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="n">trainset</span>
        <span class="n">self</span><span class="p">.</span><span class="n">testset</span> <span class="o">=</span> <span class="n">testset</span>

    <span class="c1"># Train the model
</span>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nf">set_weights</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">net</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="nf">train_model</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">net</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">trainset</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">get_weights</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">net</span><span class="p">),</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trainset</span><span class="p">),</span> <span class="p">{}</span>

    <span class="c1"># Test the model
</span>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">NDArrays</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">]):</span>
        <span class="nf">set_weights</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">net</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">net</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">testset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">testset</span><span class="p">),</span> <span class="p">{</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>


<span class="c1"># Client function
</span><span class="k">def</span> <span class="nf">client_fn</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Client</span><span class="p">:</span>
    <span class="n">net</span> <span class="o">=</span> <span class="nc">SimpleModel</span><span class="p">()</span> <span class="c1"># initialise a model for each client
</span>    <span class="n">partition_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">node_config</span><span class="p">[</span><span class="sh">"</span><span class="s">partition-id</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">client_train</span> <span class="o">=</span> <span class="n">train_sets</span><span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">partition_id</span><span class="p">)]</span> <span class="c1"># provide a training set to each client
</span>    <span class="n">client_test</span> <span class="o">=</span> <span class="n">testset</span>
    <span class="k">return</span> <span class="nc">FlowerClient</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">client_train</span><span class="p">,</span> <span class="n">client_test</span><span class="p">).</span><span class="nf">to_client</span><span class="p">()</span>

<span class="n">client</span> <span class="o">=</span> <span class="nc">ClientApp</span><span class="p">(</span><span class="n">client_fn</span><span class="p">)</span>
</code></pre></div></div> <ol> <li>Define an aggregation strategy on server side - here we use <code class="language-plaintext highlighter-rouge">FedAvg</code>.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="nc">SimpleModel</span><span class="p">()</span>
<span class="n">params</span> <span class="o">=</span> <span class="nf">ndarrays_to_parameters</span><span class="p">(</span><span class="nf">get_weights</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">server_fn</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span>
    <span class="n">strategy</span> <span class="o">=</span> <span class="nc">FedAvg</span><span class="p">(</span>
        <span class="n">fraction_fit</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="c1"># fit on 100% of the clients
</span>        <span class="n">fraction_evaluate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># evaluate on 0 clients
</span>        <span class="n">initial_parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="n">evaluate_fn</span><span class="o">=</span><span class="n">evaluate</span><span class="p">,</span> <span class="c1"># custom function to calculate accuracy after each epoch of training.
</span>    <span class="p">)</span>
    <span class="n">config</span><span class="o">=</span><span class="nc">ServerConfig</span><span class="p">(</span><span class="n">num_rounds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># no. of communication rounds.
</span>    <span class="k">return</span> <span class="nc">ServerAppComponents</span><span class="p">(</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># instantiate the server
</span><span class="n">server</span> <span class="o">=</span> <span class="nc">ServerApp</span><span class="p">(</span><span class="n">server_fn</span><span class="o">=</span><span class="n">server_fn</span><span class="p">)</span>
</code></pre></div></div> <ol> <li>Run a simulation for FL. <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1"># Initiate the simulation passing the server and client apps
# Specify the number of super nodes that will be selected on every round
</span><span class="nf">run_simulation</span><span class="p">(</span>
 <span class="n">server_app</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
 <span class="n">client_app</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
 <span class="n">num_supernodes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
 <span class="n">backend_config</span><span class="o">=</span><span class="n">backend_setup</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div> </div> </li> </ol> <p><strong>Output:</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO :      Starting Flower ServerApp, config: <span class="nv">num_rounds</span><span class="o">=</span>3, no round_timeout
INFO :      
INFO :      <span class="o">[</span>INIT]
INFO :      Using initial global parameters provided by strategy
INFO :      Evaluating initial global parameters
INFO :      <span class="nb">test </span>accuracy on all digits: 0.1267
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>1,3,7]: 0.2275
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>2,5,8]: 0.1201
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>4,6,9]: 0.0380
INFO :      
INFO :      <span class="o">[</span>ROUND 1]
INFO :      configure_fit: strategy sampled 3 clients <span class="o">(</span>out of 3<span class="o">)</span>
INFO :      aggregate_fit: received 3 results and 0 failures
INFO :      <span class="nb">test </span>accuracy on all digits: 0.8546
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>1,3,7]: 0.9477
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>2,5,8]: 0.7771
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>4,6,9]: 0.7823
INFO :      configure_evaluate: no clients selected, skipping evaluation
INFO :      
INFO :      <span class="o">[</span>ROUND 2]
INFO :      configure_fit: strategy sampled 3 clients <span class="o">(</span>out of 3<span class="o">)</span>
INFO :      aggregate_fit: received 3 results and 0 failures
INFO :      <span class="nb">test </span>accuracy on all digits: 0.9507
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>1,3,7]: 0.9619
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>2,5,8]: 0.9275
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>4,6,9]: 0.9464
INFO :      configure_evaluate: no clients selected, skipping evaluation
INFO :      
INFO :      <span class="o">[</span>ROUND 3]
INFO :      configure_fit: strategy sampled 3 clients <span class="o">(</span>out of 3<span class="o">)</span>
INFO :      aggregate_fit: received 3 results and 0 failures
INFO :      <span class="nb">test </span>accuracy on all digits: 0.9613
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>1,3,7]: 0.9672
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>2,5,8]: 0.9555
INFO :      <span class="nb">test </span>accuracy on <span class="o">[</span>4,6,9]: 0.9491
</code></pre></div></div> <blockquote> <p>We see that after 3 rounds of FL training, the accuracies of each model is close to 95% on the test set. This is a massive increase from 0% as seen before!**</p> </blockquote> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/final_model_cm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/final_model_cm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/final_model_cm-1400.webp"></source> <img src="/assets/img/final_model_cm.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="tuning">Tuning</h1> <p>There are multiple components in the FL process that can be tuned:</p> <ol> <li>Server side: <ul> <li>client selection: which clients will participate in each round</li> <li>client configuration: hyperparameters to use by each client for each round <ul> <li>hyperparameter tuning</li> </ul> </li> <li>result aggregation: methods to aggregate model weights on server side <ul> <li>QFedAvg</li> <li>FedAdam</li> <li>Vanilla FedAvg</li> <li>DP FedAvg</li> </ul> </li> </ul> </li> <li>Client-side: <ul> <li>preprocessing of weights before applying to the model</li> <li>local-training methodology</li> <li>post processing of weights before sending back to server</li> </ul> </li> </ol> <h1 id="privacy-in-federated-learning">Privacy in federated learning</h1> <p>FL is a data minimization solution. It prevents direct access to the data. However, an adversary can be present on any stage of an FL process.</p> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/privacy-fl-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/privacy-fl-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/privacy-fl-1400.webp"></source> <img src="/assets/img/privacy-fl.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>These adversaries have the objective of leaking private data of one of the clients using targetted attacks.</p> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/fl-attacks-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/fl-attacks-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/fl-attacks-1400.webp"></source> <img src="/assets/img/fl-attacks.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Therefore, many Privacy Enhancing Techniques (PETs) have been introduced to preserve the sensitive data of individuals from leaking in the case of an adversarial attack. One such is called Differential Privacy.</p> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/dp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/dp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/dp-1400.webp"></source> <img src="/assets/img/dp.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="differential-privacy-in-fl">Differential Privacy in FL</h2> <p>DP in FL aims to protect the privacy of client’s data. Depending in the intended level of privacy, utility, and the role of the adversary, it can be categorized into variants suh as central and local.</p> <p>This involves 2 steps:</p> <ol> <li> <p><strong>Clipping:</strong> Bounds the sensitivity and mitigates the impact of outliers.</p> </li> <li> <p><strong>Noising:</strong> Adds a calibrated noise to make the output statiscally indistinguishable.</p> </li> </ol> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/local-dp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/local-dp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/local-dp-1400.webp"></source> <img src="/assets/img/local-dp.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row justify-content-sm-center"> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/central-dp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/central-dp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/central-dp-1400.webp"></source> <img src="/assets/img/central-dp.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Let’s implement it using flower.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">flwr.server.strategy</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DifferentialPrivacyClientSideAdaptiveClipping</span><span class="p">,</span>
    <span class="n">FedAvg</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">server_fn</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span>
    <span class="n">fedavg_without_dp</span> <span class="o">=</span> <span class="nc">FedAvg</span><span class="p">(</span>
        <span class="n">fraction_fit</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">fraction_evaluate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">initial_parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Client side will clip the updates
</span>    <span class="n">fedavg_with_dp</span> <span class="o">=</span> <span class="nc">DifferentialPrivacyClientSideAdaptiveClipping</span><span class="p">(</span>
        <span class="n">fedavg_without_dp</span><span class="p">,</span>  <span class="c1"># &lt;- wrap the FedAvg strategy
</span>        <span class="n">noise_multiplier</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="c1"># Server will add noise after aggregation
</span>        <span class="n">num_sampled_clients</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Adjust to 50 rounds to ensure DP guarantees hold
</span>    <span class="c1"># with respect to the desired privacy budget
</span>    <span class="n">config</span> <span class="o">=</span> <span class="nc">ServerConfig</span><span class="p">(</span><span class="n">num_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nc">ServerAppComponents</span><span class="p">(</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">fedavg_with_dp</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div> <hr> <p>That is all for today folks! Blogging + learning is a long process haha, but I’m glad I learnt a bunch today!</p> <p>See you tomorrow :D</p> <h1 id="references">References</h1> <p>[1] <a href="https://learn.deeplearning.ai/courses/intro-to-federated-learning/" rel="external nofollow noopener" target="_blank">https://learn.deeplearning.ai/courses/intro-to-federated-learning/</a></p> <p>[2] <a href="https://www.v7labs.com/blog/federated-learning-guide" rel="external nofollow noopener" target="_blank">https://www.v7labs.com/blog/federated-learning-guide</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/fl-challenge-day-2/">Privacy Preserving AI</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/outreachy-week-7/">Season @ Fedora Modularity</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/outreachy-week-3/">Let's hunt those Memory Leaks!</a> </li> <div id="giscus_thread" style="max-width: 1200px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"OrionStar25/orionstar25.github.io","data-repo-id":"R_kgDOK7Nn4Q","data-category":"Announcements","data-category-id":"DIC_kwDOK7Nn4c4Ce3KD","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Niharika Shrivastava. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>